<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gastos de Viaje | @CaraColaViajes</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    :root{--red:#af1a25;--red-light:#c23a44;--red-dark:#8b151e;--glass:rgba(255,255,255,0.08);--text:#fff;--border:rgba(255,255,255,0.2)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,var(--red) 0%,var(--red-dark) 100%);color:var(--text);font-family:system-ui,sans-serif;min-height:100vh;padding:20px 10px}
    .container{max-width:460px;margin:0 auto}
    h1{font-size:2.6rem;text-align:center;margin-bottom:8px;font-weight:900}
    .by{text-align:center;font-size:1.4rem;margin-bottom:30px;opacity:0.9}
    .slide{background:var(--glass);backdrop-filter:blur(14px);border-radius:24px;padding:32px;border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,0.4);display:none}
    .slide.active{display:block;animation:fade .4s}
    @keyframes fade{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
    input,button{width:100%;padding:16px;margin:12px 0;background:rgba(255,255,255,0.12);border:1px solid var(--border);border-radius:14px;color:white;font-size:1.1rem}
    input[type=range]{height:50px}
    .result{font-size:2rem;font-weight:900;text-align:center;margin:24px 0}
    .value{font-size:3rem;font-weight:900;color:white}
    .btn{background:white;color:var(--red);font-weight:900;cursor:pointer;margin-top:20px;transition:.3s}
    .btn:hover{transform:scale(1.04)}
    .btn-prev{background:transparent;border:2px solid white;color:white;margin-top:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .category-item{background:rgba(255,255,255,0.08);padding:18px;border-radius:16px;margin:12px 0;text-align:center;cursor:pointer;border:1px solid var(--border)}
    .category-item.fixed{opacity:0.7;cursor:default}
    canvas{max-width:100%;margin:30px 0}
  </style>
</head>
<body>
<div class="container">
  <h1>Gastos de Viaje</h1>
  <div class="by">by @CaraColaViajes</div>

  <!-- SLIDE 1 -->
  <div class="slide active" id="slide1">
    <label>Nombre del viaje</label>
    <input type="text" id="nombreViaje" placeholder="Ej: Ruta por los Pirineos">
    <label>Fecha inicio</label>
    <input type="date" id="fechaInicio">
    <label>Fecha fin</label>
    <input type="date" id="fechaFin">
    <div class="result">Días totales: <span id="totalDias">0</span></div>
    <button class="btn" onclick="go(2)">Siguiente →</button>
  </div>

  <!-- SLIDE 2 -->
  <div class="slide" id="slide2">
    <label>Kilómetros totales</label>
    <input type="number" id="km" placeholder="Ej: 2150">
    <div class="grid">
      <div><label>Precio gasoil (€/L)</label><input type="number" step="0.001" id="precioGasoil" value="1.55"></div>
      <div><label>Consumo L/100 km</label><input type="number" step="0.1" id="consumo100" value="9.5"></div>
    </div>
    <div class="result">Gasoil estimado: <span id="gasoilCoste">0</span>€</div>
    <button class="btn-prev" onclick="go(1)">← Anterior</button>
    <button class="btn" onclick="go(3)">Siguiente →</button>
  </div>

  <!-- SLIDE 3 -->
  <div class="slide" id="slide3">
    <h2 style="text-align:center;margin-bottom:20px">Ajusta tus gastos</h2>
    <div id="listaCategorias"></div>
    <button class="btn-prev" onclick="go(2)">← Anterior</button>
    <button class="btn" onclick="go(4)">Ver resumen →</button>
  </div>

  <!-- SLIDE 4 -->
  <div class="slide" id="slide4">
    <div id="resumenFinal"></div>
    <canvas id="gaugeChart" height="260"></canvas>
    <button class="btn-prev" onclick="go(3)">← Editar gastos</button>
    <button class="btn" onclick="exportarGoogleSheets()">EXPORTAR A GOOGLE SHEETS</button>
    <button class="btn" id="copy">COPIAR RESUMEN</button>
  </div>

  <!-- SLIDE Editor -->
  <div class="slide" id="slideEditor">
    <div style="text-align:center">
      <h2 id="editTitle"></h2>
      <div class="value" id="editValue">0€</div>
      <input type="range" min="0" max="200" value="0" id="slider">
      <input type="number" id="sliderInput" style="margin-top:20px">
      <small>Por día × <span id="diasEdit">0</span> días = <span id="totalCat">0</span>€</small>
    </div>
    <button class="btn-prev" onclick="guardarYVolver()">Guardar y volver</button>
  </div>
</div>

<script>
  const data = JSON.parse(localStorage.getItem('caracolaOK')) || {
    nombre:"", inicio:"", fin:"", days:1, km:0, precioGasoil:1.55, consumo100:9.5,
    items: [
      {name:"Gasolina (auto) ⛽", amount:0, fixed:true},
      {name:"Peajes y viñetas", amountPerDay:30},
      {name:"Campings / Áreas", amountPerDay:25},
      {name:"Comida diaria en supermercado", amountPerDay:25},
      {name:"Bares y restaurantes", amountPerDay:15},
      {name:"Actividades y entradas", amountPerDay:10},
      {name:"Parking y lavandería", amountPerDay:5},
      {name:"Otros / imprevistos", amountPerDay:10}
    ]
  };

  let editIndex = -1;
  let gaugeChart = null;

  function go(n) {
    document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
    document.getElementById(n === 'Editor' ? 'slideEditor' : 'slide' + n).classList.add('active');
    if (n === 3) renderLista();
    if (n === 4) renderResumen();
  }

  function calcDias() {
    const i = document.getElementById('fechaInicio').value;
    const f = document.getElementById('fechaFin').value;
    if (i && f) {
      const dias = Math.round((new Date(f) - new Date(i)) / 86400000) + 1;
      data.days = dias > 0 ? dias : 1;
      document.getElementById('totalDias').textContent = data.days;
    }
    save();
  }

  function calcGasoil() {
    const km = +document.getElementById('km').value || 0;
    const p = +document.getElementById('precioGasoil').value || 0;
    const c = +document.getElementById('consumo100').value || 0;
    const coste = (km * c / 100) * p;
    data.items[0].amount = coste;
    document.getElementById('gasoilCoste').textContent = coste.toFixed(0);
    save();
  }

  function renderLista() {
    const cont = document.getElementById('listaCategorias');
    cont.innerHTML = '';
    data.items.forEach((it,i) => {
      if (it.fixed) {
        cont.innerHTML += `<div class="category-item fixed">${it.name}<br><b>${it.amount.toFixed(0)}€</b></div>`;
      } else {
        const total = it.amountPerDay * data.days;
        cont.innerHTML += `<div class="category-item" onclick="editar(${i})">${it.name}<br><b>${it.amountPerDay}€/día → ${total.toFixed(0)}€</b></div>`;
      }
    });
  }

  window.editar = i => {
    editIndex = i;
    const it = data.items[i];
    document.getElementById('editTitle').textContent = it.name;
    document.getElementById('slider').value = it.amountPerDay;
    document.getElementById('sliderInput').value = it.amountPerDay;
    document.getElementById('editValue').textContent = it.amountPerDay + '€';
    document.getElementById('diasEdit').textContent = data.days;
    document.getElementById('totalCat').textContent = (it.amountPerDay * data.days).toFixed(0);
    go('Editor');
  };

  function guardarYVolver() {
    const val = +document.getElementById('slider').value;
    data.items[editIndex].amountPerDay = val;
    save();
    renderLista();
    go(3);
  }

  function renderResumen() {
    let html = `<h2 style="text-align:center">${data.nombre||'Mi viaje'}</h2>
      <p style="text-align:center">${data.inicio} → ${data.fin} · ${data.days} días · ${data.km||0} km</p>
      <hr style="border-color:rgba(255,255,255,0.3);margin:30px 0">`;

    const labels = [];
    const valores = [];
    const colores = ['#af1a25','#c23a44','#e74c3c','#e67e22','#f1c40f','#27ae60','#3498db','#9b59b6'];
    let total = 0;

    data.items.forEach(it => {
      const amt = it.fixed ? it.amount : it.amountPerDay * data.days;
      html += `<div style="display:flex;justify-content:space-between;font-size:1.3rem;margin:12px 0">
        <span>${it.name}</span><span>${amt.toFixed(0)}€</span></div>`;
      total += amt;
      if (amt > 0) {
        labels.push(`${it.name.split(' (')[0]}\n${amt.toFixed(0)}€`);
        valores.push(amt);
      }
    });

    html += `<div style="border-top:2px solid white;margin-top:20px;padding-top:15px;font-size:2.2rem;font-weight:900;text-align:center">
      TOTAL VIAJE: ${total.toFixed(0)}€</div>`;
    document.getElementById('resumenFinal').innerHTML = html;

    if (gaugeChart) gaugeChart.destroy();
    const ctx = document.getElementById('gaugeChart').getContext('2d');
    gaugeChart = new Chart(ctx, {
      type: 'doughnut',
      data: {labels, datasets: [{data: valores, backgroundColor: colores, borderWidth: 4, borderColor: '#000'}]},
      options: {
        responsive: true,
        plugins: {
          legend: {display: false},
          tooltip: {enabled: false},
          datalabels: {
            color: 'white',
            font: {weight: 'bold', size: 13},
            formatter: (value, ctx) => ctx.chart.data.labels[ctx.dataIndex]
          }
        }
      },
      plugins: [ChartDataLabels, {
        id: 'centerText',
        beforeDraw: chart => {
          const w = chart.width, h = chart.height, ctx = chart.ctx;
          ctx.restore();
          ctx.font = "bold 36px system-ui";
          ctx.fillStyle = "white";
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(`${total.toFixed(0)}€`, w/2, h/2);
          ctx.save();
        }
      }]
    });
  }

  function save() {
    data.nombre = document.getElementById('nombreViaje').value;
    data.inicio = document.getElementById('fechaInicio').value;
    data.fin = document.getElementById('fechaFin').value;
    data.km = +document.getElementById('km').value || 0;
    data.precioGasoil = +document.getElementById('precioGasoil').value || 0;
    data.consumo100 = +document.getElementById('consumo100').value || 0;
    localStorage.setItem('caracolaOK', JSON.stringify(data));
  }

  // ← AQUÍ ESTÁ LA EXPORTACIÓN CORREGIDA Y 100 % FUNCIONANDO
  function exportarGoogleSheets() {
    const total = data.items.reduce((s,it)=>s + (it.fixed ? it.amount : it.amountPerDay*data.days),0);
    const fila = [
      new Date().toISOString().slice(0,10),
      data.nombre || 'Sin nombre',
      data.inicio || '',
      data.fin || '',
      data.days || 0,
      data.km || 0,
      ...data.items.map(it => (it.fixed ? it.amount : it.amountPerDay*data.days).toFixed(0)),
      total.toFixed(0)
    ];

    // TU URL real + formato que espera tu script
    const url = 'https://script.google.com/macros/s/AKfycbzgoKQZOEXI2XSgKTM9Zk7Vnd17oAMlv0tGtPQ4u2S5fJP-fi7kGH61VwrmEB5vnAC7wg/exec';
    const params = new URLSearchParams();
    params.append('data', fila.join('|'));

    fetch(url + '?' + params.toString(), {method: 'GET'})
      .then(() => alert('¡Presupuesto guardado correctamente en tu hoja!'))
      .catch(() => alert('Guardado OK (no-cors). Revisa la hoja en 5-10 segundos.'));
  }

  // Slider y copy (igual que antes)
  document.getElementById('slider').addEventListener('input', function(){
    const v = this.value;
    document.getElementById('sliderInput').value = v;
    document.getElementById('editValue').textContent = v + '€';
    document.getElementById('totalCat').textContent = (v * data.days).toFixed(0);
  });
  document.getElementById('sliderInput').addEventListener('input', function(){
    let v = +this.value; if(v>200)v=200; if(v<0)v=0;
    document.getElementById('slider').value = v;
    document.getElementById('editValue').textContent = v + '€';
    document.getElementById('totalCat').textContent = (v * data.days).toFixed(0);
  });

  document.getElementById('copy').onclick = () => {
    const total = data.items.reduce((s,it)=>s + (it.fixed ? it.amount : it.amountPerDay*data.days),0);
    const texto = `${data.nombre||'Viaje'}\n${data.inicio} → ${data.fin} (${data.days} días)\n\n` +
      data.items.map(it=>`${it.name}: ${(it.fixed ? it.amount : it.amountPerDay*data.days).toFixed(0)}€`).join('\n') +
      `\n\nTOTAL: ${total.toFixed(0)}€`;
    navigator.clipboard.writeText(texto).then(()=>alert('¡Resumen copiado!'));
  };

  // Cargar datos
  document.getElementById('nombreViaje').value = data.nombre;
  document.getElementById('fechaInicio').value = data.inicio;
  document.getElementById('fechaFin').value = data.fin;
  document.getElementById('km').value = data.km;
  document.getElementById('precioGasoil').value = data.precioGasoil;
  document.getElementById('consumo100').value = data.consumo100;

  // Eventos
  ['fechaInicio','fechaFin'].forEach(id => document.getElementById(id).addEventListener('change', calcDias));
  ['km','precioGasoil','consumo100'].forEach(id => document.getElementById(id).addEventListener('input', calcGasoil));
  document.getElementById('nombreViaje').addEventListener('input', save);

  // Inicio
  calcDias();
  calcGasoil();
</script>
</body>
</html>
