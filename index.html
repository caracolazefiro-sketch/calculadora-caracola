<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gastos de Viaje | @CaraColaViajes</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Gauge -->
  <style>
    :root{--red:#af1a25;--red-light:#c23a44;--red-dark:#8b151e;--glass:rgba(255,255,255,0.08);--text:#fff;--border:rgba(255,255,255,0.2)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,var(--red) 0%,var(--red-dark) 100%);color:var(--text);font-family:system-ui,sans-serif;min-height:100vh;padding:20px 10px}
    .container{max-width:460px;margin:0 auto}
    h1{font-size:2.6rem;text-align:center;margin-bottom:8px;font-weight:900}
    .by{text-align:center;font-size:1.4rem;margin-bottom:30px;opacity:0.9}
    .slide{background:var(--glass);backdrop-filter:blur(14px);border-radius:24px;padding:32px;border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,0.4);display:none}
    .slide.active{display:block;animation:fade .4s}
    @keyframes fade{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
    input,button{width:100%;padding:16px;margin:12px 0;background:rgba(255,255,255,0.12);border:1px solid var(--border);border-radius:14px;color:white;font-size:1.1rem}
    input[type=range]{height:50px}
    .result{font-size:2rem;font-weight:900;text-align:center;margin:24px 0}
    .value{font-size:3rem;font-weight:900;color:white}
    .btn{background:white;color:var(--red);font-weight:900;cursor:pointer;margin-top:30px;transition:.3s}
    .btn:hover{transform:scale(1.04)}
    .btn-prev{background:transparent;border:2px solid white;color:white;margin-top:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .category-item{background:rgba(255,255,255,0.08);padding:18px;border-radius:16px;margin:12px 0;text-align:center;cursor:pointer;border:1px solid var(--border)}
    .category-item.fixed{opacity:0.7;cursor:default}
    canvas{max-width:100%;margin:20px 0}
  </style>
</head>
<body>
<div class="container">
  <h1>Gastos de Viaje</h1>
  <div class="by">by @CaraColaViajes</div>

  <!-- Los 4 slides anteriores (1,2,3,Editor) igual que antes -->
  <!-- (Los mantengo idénticos para no repetir 300 líneas, solo copio el nuevo slide 4 con el gauge) -->

  <!-- SLIDE 4: Resumen + Gauge + Exportar -->
  <div class="slide" id="slide4">
    <div id="resumenFinal"></div>
    <canvas id="gaugeChart" height="220"></canvas>
    
    <button class="btn-prev" onclick="go(3)">← Editar gastos</button>
    <button class="btn" onclick="exportarGoogleSheets()">EXPORTAR A GOOGLE SHEETS</button>
    <button class="btn" id="copy">COPIAR RESUMEN</button>
  </div>

  <!-- Slides 1,2,3 y Editor son exactamente iguales que en el mensaje anterior -->
  <!-- Solo añado aquí el nuevo código del gauge y export -->

<script>
  // ← Aquí va todo el código JavaScript anterior (data, go(), calcDias(), calcGasoil()…) 
  // Lo tienes en el mensaje anterior, cópialo tal cual hasta la línea save();

  let gaugeChart = null;

  function renderResumen() {
    let html = `<h2 style="text-align:center">${data.nombre||'Mi viaje'}</h2>
      <p style="text-align:center">${data.inicio} → ${data.fin} · ${data.days} días · ${data.km||0} km</p>
      <hr style="border-color:rgba(255,255,255,0.3);margin:30px 0">`;
    let total = 0;
    const categorias = [];
    const valores = [];
    const colores = ['#af1a25','#c23a44','#e74c3c','#e67e22','#f1c40f','#27ae60','#3498db'];

    data.items.forEach(it=>{
      const amt = it.fixed ? it.amount : it.amountPerDay * data.days;
      html += `<div style="display:flex;justify-content:space-between;font-size:1.3rem;margin:12px 0">
        <span>${it.name}</span><span>${amt.toFixed(0)}€</span></div>`;
      total += amt;
      if (amt > 0) {
        categorias.push(it.name.split(' (')[0]);
        valores.push(amt);
      }
    });
    html += `<div style="border-top:2px solid white;margin-top:20px;padding-top:15px;font-size:2.2rem;font-weight:900;text-align:center">
      TOTAL VIAJE: ${total.toFixed(0)}€</div>`;
    document.getElementById('resumenFinal').innerHTML = html;

    // GAUGE
    if (gaugeChart) gaugeChart.destroy();
    const ctx = document.getElementById('gaugeChart').getContext('2d');
    gaugeChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: categorias,
        datasets: [{
          data: valores,
          backgroundColor: colores,
          borderWidth: 3,
          borderColor: '#111'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {position:'bottom',labels:{color:'white',font:{size:14}}},
          tooltip: {callbacks:{label: ctx => `${ctx.label}: ${ctx.raw.toFixed(0)}€`}}
        }
      }
    });
  }

  // EXPORTAR A GOOGLE SHEETS (solo tienes que crear la hoja una vez)
  function exportarGoogleSheets() {
    const total = data.items.reduce((s,it)=>s + (it.fixed ? it.amount : it.amountPerDay*data.days),0);
    const fila = [
      new Date().toISOString().split('T')[0], // fecha exportación
      data.nombre || 'Sin nombre',
      data.inicio, data.fin, data.days,
      data.km || 0,
      data.items.map(it=>it.fixed ? it.amount : it.amountPerDay*data.days),
      total
    ].flat();

    // ← URL DE TU GOOGLE SHEET (la creas en 30 segundos) →
    const SHEET_ID = '1x9z9z9z9z9z9z9z9z9z9z9z9z9z9z9z9z9z9z9'; // ← PONDRE LA TUYA EN 2 MIN
    const url = `https://script.google.com/macros/s/AKfycbw.../exec?sheet=${SHEET_ID}&data=${encodeURIComponent(fila.join('|'))}`;
    
    fetch(url)
      .then(()=>alert('¡Presupuesto guardado en tu historial de Google Sheets!'))
      .catch(()=>alert('Error al guardar. Crea la hoja primero (te paso el enlace en 1 min)'));
  }

  // Resto del código anterior (copy, eventos, init…) igual
</script>
</body>
</html>
